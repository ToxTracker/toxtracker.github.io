<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:;position:fixed;top:0;right:0;bottom:0;left:0; }
    h1 {
      font-weight: bold;
      color: #ff4747;
      font-size: 30px;
      font-family: Arial, Helvetica, sans-serif;
    }
    /* width */
    ::-webkit-scrollbar {
      width: 10px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #f1f1f1; 
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #888; 
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #555; 
    }
    .province {
        fill: #000;
        stroke: #fff;
        stroke-width: 1px;
    }
    .province:hover {
        fill: #666;
    }
    .hidden {
        display: none;
    }
    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 2px;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
    .slidecontainer {
      width: 100%;
    }

    .slider {
      -webkit-appearance: none;
      width: 450px;
      height: 25px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider:hover {
      opacity: 1;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      background: #4CAF50;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      background: #4CAF50;
      cursor: pointer;
    }
  </style>
</head>

<body> 
  <h1 align="center">ToxTracker</h1>
  <script>
    var station_array = [], station_m_array = [];
		var width = 450,
        height = 650,
        scale = 90000,
        X = 5.11,
        Y = 45.785,
        monthValue = "12-2017";
		var link_json = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/lyon.geojson",
//         link_data = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data.json",
  			link_data_new = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data_new.json",
        link_slider = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data/slider_value.csv",
    		link_tox = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data/toxines.csv";
    var q = d3.queue();
    q.defer(d3.json, link_data_new)
      .defer(d3.csv, link_tox)
      .defer(d3.csv, link_slider)
      .defer(d3.json, link_json)
    	.await(processData);
    function processData(err, a_data, tox, slider , json){
      var year = "y" + monthValue;
      map(X,Y,scale, a_data[year], tox, json, a_data, slider);
      d3.select("#timeslide").on("input", function() {
        monthValue = slider[this.value].slider_val;
        year = "y" + monthValue;
        d3.select('#month').html(monthValue);
        map(X,Y,scale, a_data[year], tox, json, a_data, slider);
        
      });
    };
        
    var div = d3.select("body")
      .append("div")
    	.attr("id", "viz")
    	.attr("top", 10)
    	.attr("left", 10)
		  .attr( "width", width*3+120 )
		  .attr( "height", height );    
		var svg = div.append( "svg" )
		  .attr( "class", "svg_carte")
		  .attr( "width", width)
		  .attr( "height", height );     
    var svg2 = div.append( "svg" )
		  .attr( "class", "svg_chart")
		  .attr( "width", width*2+120)
		  .attr( "height", height );
    
    // On rajoute un groupe englobant toute la visualisation pour plus tard
    var g = svg.append( "g" ); 
    
    var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');
    var projection = d3.geoConicConformal()
    					.center([X, Y]).scale(scale);
    
		// On definie une echelle de couleur
		
    var color = d3.scaleQuantize()
      .range(["#10f400","#7ef400","#f4e800","#f49f00","#f41400"]),
        color_legend = d3.scaleQuantize()
      .range(["steelblue","darkviolet","firebrick","palegreen"]).domain([0,4]);
    color.domain([0,150]);
    var c_lyon = "#00ffee",
        c_lyon_mouseOn = "#007f77",
        c_n_lyon = "#ccc",
        c_n_lyon_mouseOn = "#666"
    
    var lyon_commune = ["Lyon", "Mulatière", "Villeurbanne",
                        "Saint-Fons", "Vaulx-en-Velin", "Bron", 
                        "Vénissieux", "Pierre-Bénite", "Feyzin",
                        "Miribel", "Vauls-en-Velin", "Bron", 
                        "Solaize","Albigny-sur-Saône", 
                        "Cailloux-sur-Fontaines", "Caluire-et-Cuire",
                        "Champagne-au-Mont-d'Or", "Charbonnières-les-Bains",
                        "Charly", "Chassieu", "Collonges-au-Mont-d'Or",
                        "Corbas", "Couzon-au-Mont-d'Or", "Craponne", 
                        "Curis-au-Mont-d'Or", "Dardilly", 
                        "Décines-Charpieu", "Écully", "Neyron",
                        "Fleurieu-sur-Saône", "Fontaines-Saint-Martin", 
                        "Fontaines-sur-Saône", "Francheville", "Genay",
                        "Givors","Grigny", "Irigny", "Jonage", 
                        "La Mulatière", "La Tour de Salvagny", "Limonest",
                        "Lissieu", 
                        "Marcy-l'Etoile", "Meyzieu", "Mions", "Montanay", 
                        "Neuville-sur-Saône", "Oullins", "Pierre-Bénite", 
                        "Poleymieux-au-Mont-d'Or", "Quincieux",
                        "Rillieux-la-Pape", 
                        "Rochetaillée-sur-Saône", "Saint-Cyr-au-Mont-d'Or", 
                        "Saint-Didier-au-Mont-d'Or", "Saint-Genis-Laval", 
                        "Saint-Genis-les-Ollières", 
                        "Saint-Germain-au-Mont-d'Or", 
                        "Saint-Priest", "Saint-Romain-au-Mont-d'Or", 
                        "Sainte-Foy-lès-Lyon", 
                        "Sathonay-Camp", "Sathonay-Village", 
                        "Tassin-la-Demi-Lune", "Vernaison", "Ternay"
                       ];
    var path = d3.geoPath()
                 .projection(projection); 
    // dot coloration
    function red_dot(d){
      d3.selectAll(".dot").filter(function(e) {
        return e === d;
      }).style("fill", "red");
    }
    function color_array(array, tox){
      d3.selectAll(".dot").style("fill", function(d,i){
        	if(d.value == -1) return "#ccc";
        	return color(d.value);
        })
      array.forEach(function(d){
        red_dot(d);
      });
    }
    // chart_array
    function chart_array(array, m_array, tox, slider, a_data){
      svg2.selectAll("g").remove();
      array.forEach(function(d,i){
        chart(d, m_array[i],tox,i+1, slider, a_data);
      });
    }
    // chart
    function chart(data, month , tox, pos, slider, a_data){
      if(pos == 3) return;
      slider.forEach(function (e){
          tox.forEach(function(f){
            a_data["y"+e.slider_val].forEach(function(g){
              if(g["code_station"]===data["code_station"]){
            		e[f.toxine]=g[f.toxine];
              }
            });
          });
        });
      var x = d3.scaleLinear().range([65, width-50]).domain([0, tox.length - 1]);
      var y = d3.scaleLinear().range([0, height/3]).domain([0, 126.7]);
      var xScale = d3.scaleBand()
        .domain(tox.map(function(d){ return d.toxine; }))
        .range([0, width]);
      var yScale = d3.scaleLinear().range([height/3,0]).domain([0, 126.7]);
      var xAxis = d3.axisBottom()
        .scale(xScale).ticks(17);
      var yAxis = d3.axisLeft()
        .scale(yScale).ticks(8);
      var sc =0.9;
      svg2.append( "g" )
    	.attr("transform", "translate("+((50+width)*(pos - 1) + 40)+" ,30)")
        .append("text")
        .text(data.nom_station + " - " + month)
      ;
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,40)")
        .call(yAxis)
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/3 + 40) +")")
        .call(xAxis)
        .selectAll("text")	
        .style("text-anchor", "end")
        .style("font-size", 12)
        .style("font-family", "monospace")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {
        return "rotate(-65)" 
      });
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,40)")
      	.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("height", y(126.7))
        .attr("width", width )
      	.attr("fill", "#ffffff")
        .style("stroke", "#000")
        .style("stroke-width", "1")
        .attr("opacity", 0.5)
      
      svg2.append( "g" )
        .attr("transform", "translate("+(width*(pos - 1)*1.08 + 10)+" ,0)")
      	.selectAll("rect").data(tox).enter()
          .append("rect")
          .attr("class", "tox")
          .attr("x", function(d,i){ return x(i);})
          .attr("y",function(d){ return height/3 +40- y(data[d.toxine]); })
          .attr("height", function(d){ return y(data[d.toxine]); })
          .attr("width", 30 )
      		.attr("fill", function(d,i){
              return color_legend(i);
            });
      svg2.append( "g" )
        .attr("transform", "translate("+(width*(pos - 1)*1.08 + 10)+" ,0)")
      	.selectAll("#tooltip").data(tox).enter().append("text")
          .attr("id", "tooltip")
          .text(function(d) { return data[d.toxine]; })
          .attr("class", "tox_val")
          .attr("x", function(d,i){ return x(i);})
          .attr("y",function(d){ return height/3 +35- y(data[d.toxine]); });
      
      //line chart
//       var xScaleLine = d3.scaleBand()
//         .domain(slider.map(function(d){ return d.slider_val; }))
//         .range([0, width]);
      
			var parseTime = d3.timeParse("%m-%Y");
      var xScaleLine = d3.scaleTime()
//         .domain(d3.extent(slider,function(d){ return parseTime(d.slider_val); }))
        .range([0, width]);
      
      var yScaleLine = d3.scaleLinear().range([height/3,0]);
//       			.domain([0, 126.7]);
      xAxis = d3.axisBottom(xScaleLine);
      svg2.append( "g" )
        .attr("transform", "translate("+(width*(pos - 1)*1.08 + 10)+" ,0)")
      	.selectAll("rect").data(tox).enter()
          .append("rect")
          .attr("class", "leg")
          .attr("x", function(d,i){ return x(i)-50;})
          .attr("y",function(d){ return height/3 +120; })
          .attr("height", 10 )
          .attr("width", 10 )
      		.attr("fill", function(d,i){
        return color_legend(i);
      });
      svg2.append( "g" )
        .attr("transform", "translate("+(width*(pos - 1)*1.08 + 10)+" ,0)")
      	.selectAll("text").data(tox).enter()
          .append("text")
          .attr("class", "leg")
          .attr("x", function(d,i){ return x(i)-30;})
          .attr("y",function(d){ return height/3 +130; })
      		.text(function(d){return d.toxine;})
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + ","+ (height/2 + 40) +")")
        .call(yAxis);
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/2 + 40) +")")
      	.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("height", y(126.7))
        .attr("width", width )
      	.attr("fill", "#ffffff")
        .style("stroke", "#000")
        .style("stroke-width", "1")
        .attr("opacity", 0.5)
      var line1 = d3.line()
        .x(function(d) { return xScaleLine(parseTime(d.slider_val)); }) 
        .y(function(d) { 
          if (d["pm10"]){
          	return yScaleLine(d["pm10"]); 
          }
          return yScaleLine(0);
        }) 
      var line2 = d3.line()
        .x(function(d) { return xScaleLine(parseTime(d.slider_val)); }) 
        .y(function(d) { 
          if (d["so2"]){
          	return yScaleLine(d["so2"]); 
          }
          return yScaleLine(0);
        }) 
      var line3 = d3.line()
        .x(function(d) { return xScaleLine(parseTime(d.slider_val)); }) 
        .y(function(d) { 
          if (d["no2"]){
          	return yScaleLine(d["no2"]); 
          }
          return yScaleLine(0);
        }) 
      var line4 = d3.line()
        .x(function(d) { return xScaleLine(parseTime(d.slider_val)); }) 
        .y(function(d) { 
          if (d["ozone"]){
          	return yScaleLine(d["ozone"]); 
          }
          return yScaleLine(0);
        }) 
        .curve(d3.curveMonotoneX);
      xScaleLine.domain(d3.extent(slider,function(d){ return parseTime(d.slider_val); }));
      yScaleLine.domain([0, 126.7]);
      
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height - 68) +")")
        .call(xAxis)
        .selectAll("text")	
        .style("text-anchor", "end")
        .style("font-size", 12)
        .style("font-family", "monospace")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {
        return "rotate(-65)"
      });
      svg2.append("g")
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/2 + 40) +")")
      	.append("path")
        .data([slider])
        .attr("class", "line")
      	.style("stroke", "firebrick")
        .attr("d", line1);
      svg2.append("g")
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/2 + 40) +")")
      	.append("path")
        .data([slider])
        .attr("class", "line")
      	.style("stroke", "steelblue")
        .attr("d", line2);
      svg2.append("g")
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/2 + 40) +")")
      	.append("path")
        .data([slider])
        .attr("class", "line")
      	.style("stroke", "darkviolet")
        .attr("d", line3);
      svg2.append("g")
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/2 + 40) +")")
      	.append("path")
        .data([slider])
        .attr("class", "line")
      	.style("stroke", "palegreen")
        .attr("d", line4);
    };
    
    // carte
    function map(X,Y, scale, data, tox, json, a_data, slider){
      
      
      g.selectAll("circle").remove();
      g.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "zone")
        .style("stroke", "#050505")
        .style("stroke-width", "0.2")
        .style("fill", "#ccc")
        .on('mousemove', function(d) {    
          d3.selectAll(".zone")
            .filter(function(e) {
            return e === d;
          })
            .style("fill", function(e) {
            var nom = lyon_commune.indexOf(e.properties.nom);
            if(nom >= 0){
              return c_lyon_mouseOn;
            } else { 
              return c_n_lyon_mouseOn;
            }
          });
          var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 15) +
                  'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.properties.nom);
        })
        .on('mouseout', function(d) {
          tooltip.classed('hidden', true);
          d3.selectAll(".zone").filter(function(e) {
            return e === d;
          }).style("fill", function(d) {
            var nom = lyon_commune.indexOf(d.properties.nom);
            if(nom >= 0){
              return c_lyon;
            } else { 
              return c_n_lyon;
            }
          })
        });
      g.selectAll(".zone").filter(function(d) {
        if(lyon_commune.indexOf(d.properties.nom) >= 0){
          return d;
        };
      }).style("fill", c_lyon)
        .style("stroke", "#ff0000")
        .style("stroke-width", "1");

      g.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("r", 8)
        .attr("class", "dot")
        .attr("cx", function(d) { return projection([d.X, d.Y])[0]; })
        .attr("cy", function(d) { return projection([d.X, d.Y])[1]; })
        .style("fill", function(d){
          var cnt = 0;
        	var value = 0;
          for (i = 0; i < tox.length; i++) { 
            var toxine = tox[i].toxine;
            if(d[toxine]){ 
              value = value + parseInt(d[toxine], 10);
            } else {
              cnt = cnt + 1;
              value = value + 0;
            };  
          };
        	d.value = value;
        	if (cnt == 4) {
            d.value = -1;
            return "#ccc";
          };
        	return color(value);
        })
        .style("stroke", "#000")
        .style("stroke-width", "2")
        .on('mouseover', function(d) {
          d3.selectAll(".dot").filter(function(e) {
            return e === d;
          }).attr("r", 10)
            .style("stroke-width", "4")
          ;
        	chart_array(station_array, station_m_array, tox, slider,a_data);
          chart(d,monthValue, tox, station_array.length + 1, slider, a_data);
        })
        .on('mouseout', function(d) {
        	chart_array(station_array, station_m_array, tox, slider,a_data);
          d3.selectAll(".dot").filter(function(e) {
            return e === d;
          }).attr("r", 8)
            .style("stroke-width", "2");
        })
      	.on('click', function(d) {
          if (station_array.indexOf(d) === -1){
            if (station_array.length < 2){
              d.month = monthValue;
              station_m_array.push(monthValue)
              station_array.push(d);
            } else {
              station_m_array.pop()
              station_array.pop();
              station_m_array.push(monthValue)
              d.month = monthValue;
              
              station_array.push(d);
            };
            
          } else {
            
            station_m_array.splice(station_array.indexOf(d),1)
            station_array.splice(station_array.indexOf(d),1);
          };
        	color_array(station_array,tox);
        	chart_array(station_array, station_m_array, tox, slider,a_data);
        })
      ;
    }
    
  </script>
  <div id="sliderContainer" width="450">
    <input id="timeslide" type="range" min="0" max="12" value="0" step="1" class="slider" id="myRange"  width="450"/><br>
    <span id="month">month</span>
  </div>
</body>
