<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    .province {
        fill: #000;
        stroke: #fff;
        stroke-width: 1px;
    }
    .province:hover {
        fill: #666;
    }
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
  </style>
</head>

<body> 
  <div id="sliderContainer">
    <input id="timeslide" type="range" min="0" max="12" value="0" step="1"/><br>
    <span id="month">month</span>
  </div>
  <script>
    var station_array = [], station_m_array = [];
		var width = 450,
        height = 650,
        scale = 90000,
        X = 5.11,
        Y = 45.785,
        y = "12-2017";
		var link_json = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/lyon.geojson",
//         link_data = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data.json",
  			link_data_new = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data_new.json",
        link_slider = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data/slider_value.csv",
    		link_tox = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data/toxines.csv";
    var q = d3.queue();
    q.defer(d3.json, link_data_new)
      .defer(d3.csv, link_tox)
      .defer(d3.csv, link_slider)
      .defer(d3.json, link_json)
    	.await(processData);
    function processData(err, a_data, tox, slider , json){
      var year = "y" + y;
      map(X,Y,scale, a_data[year], tox, json, a_data, slider);
      d3.select("#timeslide").on("input", function() {
        var monthValue = slider[this.value].slider_val;
        year = "y" + monthValue;
        d3.select('#month').html(monthValue);
        map(X,Y,scale, a_data[year], tox, json, a_data, slider);
        
      });
    };
        
    var div = d3.select("body")
      .append("div")
    	.attr("id", "viz")
    	.attr("top", 10)
    	.attr("left", 10)
		  .attr( "width", width*3 +120 )
		  .attr( "height", height ); 
    var div = d3.select("body")
      .append("div")        
		var svg = div.append( "svg" )
		  .attr( "class", "svg_carte")
		  .attr( "width", width)
		  .attr( "height", height );
    var svg2 = div.append( "svg" )
		  .attr( "class", "svg_chart")
		  .attr( "width", width*2+120)
		  .attr( "height", height );
    
    // On rajoute un groupe englobant toute la visualisation pour plus tard
    var g = svg.append( "g" ); 
    
    var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');
    var projection = d3.geoConicConformal()
    					.center([X, Y]).scale(scale);
    
		// On definie une echelle de couleur
		var color = d3.scaleQuantize()  
    			.range(["rgb(237,248,233)",
									"rgb(186,228,179)",
                  "rgb(116,196,118)",
                  "rgb(49,163,84)",
                  "rgb(0,109,44)"]);
    var c_lyon = "#ffee00",
        c_lyon_mouseOn = "#009900",
        c_n_lyon = "#ccc",
        c_n_lyon_mouseOn = "#666"
    
    var lyon_commune = ["Lyon", "Mulatière", "Villeurbanne",
                        "Saint-Fons", "Vaulx-en-Velin", "Bron", 
                        "Vénissieux", "Pierre-Bénite", "Feyzin",
                        "Miribel", "Vauls-en-Velin", "Bron", 
                        "Solaize","Albigny-sur-Saône", 
                        "Cailloux-sur-Fontaines", "Caluire-et-Cuire",
                        "Champagne-au-Mont-d'Or", "Charbonnières-les-Bains",
                        "Charly", "Chassieu", "Collonges-au-Mont-d'Or",
                        "Corbas", "Couzon-au-Mont-d'Or", "Craponne", 
                        "Curis-au-Mont-d'Or", "Dardilly", 
                        "Décines-Charpieu", "Écully", "Neyron",
                        "Fleurieu-sur-Saône", "Fontaines-Saint-Martin", 
                        "Fontaines-sur-Saône", "Francheville", "Genay",
                        "Givors","Grigny", "Irigny", "Jonage", 
                        "La Mulatière", "La Tour de Salvagny", "Limonest",
                        "Lissieu", 
                        "Marcy-l'Etoile", "Meyzieu", "Mions", "Montanay", 
                        "Neuville-sur-Saône", "Oullins", "Pierre-Bénite", 
                        "Poleymieux-au-Mont-d'Or", "Quincieux",
                        "Rillieux-la-Pape", 
                        "Rochetaillée-sur-Saône", "Saint-Cyr-au-Mont-d'Or", 
                        "Saint-Didier-au-Mont-d'Or", "Saint-Genis-Laval", 
                        "Saint-Genis-les-Ollières", 
                        "Saint-Germain-au-Mont-d'Or", 
                        "Saint-Priest", "Saint-Romain-au-Mont-d'Or", 
                        "Sainte-Foy-lès-Lyon", 
                        "Sathonay-Camp", "Sathonay-Village", 
                        "Tassin-la-Demi-Lune", "Vernaison", "Ternay"
                       ];
    var path = d3.geoPath()
                 .projection(projection); 
    // dot coloration
    function red_dot(d){
      d3.selectAll(".dot").filter(function(e) {
        return e === d;
      }).style("fill", "red");
    }
    function color_array(array){
      d3.selectAll(".dot").style("fill", "blue");
      array.forEach(function(d){
        red_dot(d);
      });
    }
    // chart_array
    function chart_array(array, m_array, tox){
      svg2.selectAll("g").remove();
      array.forEach(function(d,i){
        chart(d, m_array[i],tox,i+1);
      });
    }
    // chart
    function chart(data, month , tox, pos){
      if(pos == 3) return;
      var toxines = [];
      var x = d3.scaleLinear().range([65, width-50]).domain([0, tox.length - 1]);
      var y = d3.scaleLinear().range([0, height/3]).domain([0, 126.7]);
      var xScale = d3.scaleBand()
        .domain(tox.map(function(d){ return d.toxine; }))
        .range([0, width]);
      var yScale = d3.scaleLinear().range([height/3,0]).domain([0, 126.7]);
      for (i = 0; i < tox.length; i++) { 
        var toxine = tox[i].toxine;
        toxines.push(toxine);
        var value = parseInt(data[toxine], 10);  
      };
      
      var xAxis = d3.axisBottom()
        .scale(xScale).ticks(17);
      var yAxis = d3.axisLeft()
        .scale(yScale).ticks(8);
      var sc =0.9;
      svg2.append( "g" )
    	.attr("transform", "translate("+((50+width)*(pos - 1) + 40)+" ,30)")
        .append("text")
        .text(data.nom_station + " - " + month)
      ;
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,40)")
        .call(yAxis)
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,"+ (height/3 + 40) +")")
        .call(xAxis)
        .selectAll("text")	
        .style("text-anchor", "end")
        .style("font-size", 12)
        .style("font-family", "monospace")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {
        return "rotate(-65)" 
      });
      svg2.append( "g" )
        .attr("transform", "translate(" + ((40+width)*(pos - 1) + 30) + " ,40)")
      	.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("height", y(126.7))
        .attr("width", width )
      	.attr("fill", "#ffffff")
        .style("stroke", "#000")
        .style("stroke-width", "1")
        .attr("opacity", 0.5)
      
      var g2 = svg2.append( "g" )
        .attr("transform", "translate("+(width*(pos - 1)*1.08 + 10)+" ,0)")
      	.selectAll("rect").data(tox).enter()
          .append("rect")
          .attr("class", "tox")
          .attr("x", function(d,i){ return x(i);})
          .attr("y",function(d){ return height/3 +40- y(data[d.toxine]); })
          .attr("height", function(d){ return y(data[d.toxine]); })
          .attr("width", 30 )
          .on('mouseover', function(d,i) {
            d3.selectAll(".tox").filter(function(e) {
              return e === d;
            }).attr("fill", "#32ffea");
          })
          .on('mouseout', function(d) {
            d3.selectAll(".tox").filter(function(e) {
              return e === d;
            }).attr("fill", "#000000");
          });
      svg2.append( "g" )
        .attr("transform", "translate("+(width*(pos - 1)*1.08 + 10)+" ,0)")
      	.selectAll("#tooltip").data(tox).enter().append("text")
          .attr("id", "tooltip")
          .text(function(d) { return data[d.toxine]; })
          .attr("class", "tox")
          .attr("x", function(d,i){ return x(i);})
          .attr("y",function(d){ return height/3 +35- y(data[d.toxine]); });
    };
    
    // carte
    function map(X,Y, scale, data, tox, json, a_data, slider){
      g.selectAll("circle").remove();
      g.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "zone")
        .style("stroke", "#050505")
        .style("stroke-width", "0.2")
        .style("fill", "#ccc")
        .on('mousemove', function(d) {    
          d3.selectAll(".zone")
            .filter(function(e) {
            return e === d;
          })
            .style("fill", function(e) {
            var nom = lyon_commune.indexOf(e.properties.nom);
            if(nom >= 0){
              return c_lyon_mouseOn;
            } else { 
              return c_n_lyon_mouseOn;
            }
          });
          var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 15) +
                  'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.properties.nom);
        })
        .on('mouseout', function(d) {
          tooltip.classed('hidden', true);
          d3.selectAll(".zone").filter(function(e) {
            return e === d;
          }).style("fill", function(d) {
            var nom = lyon_commune.indexOf(d.properties.nom);
            if(nom >= 0){
              return c_lyon;
            } else { 
              return c_n_lyon;
            }
          })
        });
      g.selectAll(".zone").filter(function(d) {
        if(lyon_commune.indexOf(d.properties.nom) >= 0){
          return d;
        };
      }).style("fill", c_lyon)
        .style("stroke", "#ff0000")
        .style("stroke-width", "1");

      g.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("r", 5)
        .attr("class", "dot")
        .attr("cx", function(d) { return projection([d.X, d.Y])[0]; })
        .attr("cy", function(d) { return projection([d.X, d.Y])[1]; })
        .style("fill", "blue")
        .style("stroke", "#000")
        .style("stroke-width", "2")
        .on('mouseover', function(d) {
          d3.selectAll(".dot").filter(function(e) {
            return e === d;
          }).attr("r", 10)
            .style("stroke-width", "4");
        	chart_array(station_array, station_m_array, tox);
          chart(d,y, tox, station_array.length + 1);
        })
        .on('mouseout', function(d) {
        	chart_array(station_array, station_m_array, tox);
          d3.selectAll(".dot").filter(function(e) {
            return e === d;
          }).attr("r", 5)
            .style("stroke-width", "2");
        })
      	.on('click', function(d) {
          if (station_array.indexOf(d) === -1){
            if (station_array.length < 2){
              station_m_array.push(y)
              station_array.push(d);
            } else {
              station_m_array.pop()
              station_array.pop();
              station_m_array.push(y)
              station_array.push(d);
            };
            
          } else {
            
            station_m_array.splice(station_array.indexOf(d),1)
            station_array.splice(station_array.indexOf(d),1);
          };
        	color_array(station_array);
        	chart_array(station_array, station_m_array, tox);
        })
      ;
    }
    
  </script>
</body>
