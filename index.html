<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    .province {
        fill: #000;
        stroke: #fff;
        stroke-width: 1px;
    }
    .province:hover {
        fill: #666;
    }
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
  </style>
</head>

<body> 
  <script>
		var width = 500,
  		  height = 650,
        scale = 90000,
        X = 5.09,
        Y = 45.785;
		var link_json = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/lyon.geojson",
        link_data = "https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/2012.csv";
    		link_tox ="https://raw.githubusercontent.com/ToxTracker/toxtracker.github.io/master/data/toxines.csv"
    var q = d3.queue();
    q.defer(d3.csv, link_data)
      .defer(d3.csv, link_tox)
      .defer(d3.json, link_json)
    	.await(processData);
    function processData(err, data, tox, json){
      map(X,Y,scale, data, tox, json);
    };
    
    var div = d3.select("body")
      .append("div")
    	.attr("top", 10)
    	.attr("left", 10)
		  .attr( "width", width*2 )
		  .attr( "height", height ); 
            
		var svg = div.append( "svg" )
		  .attr( "class", "svg_carte")
		  .attr( "width", width)
		  .attr( "height", height );
    var svg2 = div.append( "svg" )
		  .attr( "class", "svg_something")
		  .attr( "width", width)
		  .attr( "height", height );
    
    // On rajoute un groupe englobant toute la visualisation pour plus tard
    var g = svg.append( "g" )
		  .attr( "width", width )
		  .attr( "height", height ); 
    
    var g2 = svg2.append( "g" )
		  .attr( "width", width )
		  .attr( "height", height/2 )
    	.attr("transform", "translate(30 ,30)"); 
    
    var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');
    var projection = d3.geoConicConformal()
    					.center([X, Y]).scale(scale);
    
		// On definie une echelle de couleur
		var color = d3.scaleQuantize()  
    			.range(["rgb(237,248,233)",
									"rgb(186,228,179)",
                  "rgb(116,196,118)",
                  "rgb(49,163,84)",
                  "rgb(0,109,44)"]);
    var c_lyon = "#00ff00",
        c_lyon_mouseOn = "#009900",
        c_n_lyon = "#ccc",
        c_n_lyon_mouseOn = "#666"
    
    var lyon_commune = ["Lyon", "Mulatière", "Villeurbanne",
                        "Saint-Fons", "Vaulx-en-Velin", "Bron", 
                        "Vénissieux", "Pierre-Bénite", "Feyzin",
                        "Miribel", "Vauls-en-Velin", "Bron", 
                        "Solaize","Albigny-sur-Saône", 
                        "Cailloux-sur-Fontaines", "Caluire-et-Cuire",
                        "Champagne-au-Mont-d'Or", "Charbonnières-les-Bains",
                        "Charly", "Chassieu", "Collonges-au-Mont-d'Or",
                        "Corbas", "Couzon-au-Mont-d'Or", "Craponne", 
                        "Curis-au-Mont-d'Or", "Dardilly", 
                        "Décines-Charpieu", "Écully", "Neyron",
                        "Fleurieu-sur-Saône", "Fontaines-Saint-Martin", 
                        "Fontaines-sur-Saône", "Francheville", "Genay",
                        "Givors","Grigny", "Irigny", "Jonage", 
                        "La Mulatière", "La Tour de Salvagny", "Limonest",
                        "Lissieu", 
                        "Marcy-l'Etoile", "Meyzieu", "Mions", "Montanay", 
                        "Neuville-sur-Saône", "Oullins", "Pierre-Bénite", 
                        "Poleymieux-au-Mont-d'Or", "Quincieux",
                        "Rillieux-la-Pape", 
                        "Rochetaillée-sur-Saône", "Saint-Cyr-au-Mont-d'Or", 
                        "Saint-Didier-au-Mont-d'Or", "Saint-Genis-Laval", 
                        "Saint-Genis-les-Ollières", 
                        "Saint-Germain-au-Mont-d'Or", 
                        "Saint-Priest", "Saint-Romain-au-Mont-d'Or", 
                        "Sainte-Foy-lès-Lyon", 
                        "Sathonay-Camp", "Sathonay-Village", 
                        "Tassin-la-Demi-Lune", "Vernaison", "Ternay"
                       ];
    var path = d3.geoPath()
                 .projection(projection); 
    // chart
    function chart(data, tox){
      var toxValue = [];      
      var x = d3.scaleLinear().range([0, width]).domain([0, tox.length]);
      var y = d3.scaleLinear().range([0, height/2]).domain([0, 10000]);
      for (i = 0; i < tox.length; i++) { 
        var toxine = tox[i].toxine;
        toxValue.push(data[toxine]);
        g2.append("rect")
          .attr("x", x(i))
          .attr("y", height/2 - y(data[toxine]))
          .attr("height", y(data[toxine]))
          .attr("width", 10 );        
      };
      var x = d3.scaleLinear().range([0, width]).domain([0, tox.length]);
      var y = d3.scaleLinear().range([0, height/2]).domain([0, 84]);
      g2.append("text")
        .text(d3.max(toxValue));
      
      for (i = 0; i < tox.length; i++) { 
        g2.append("rect")
          .attr("x", x(i))
          .attr("y", height/2 - y(data[toxine]))
          .attr("height", y(data[toxine]))
          .attr("width", 10 );
      };
    };
    
    // carte
    function map(X,Y, scale, data, tox, json){
      g.selectAll().remove();
      g.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "zone")
        .style("stroke", "#050505")
        .style("stroke-width", "0.2")
        .style("fill", "#ccc")
        .on('mousemove', function(d) {    
          d3.selectAll(".zone")
            .filter(function(e) {
            return e === d;
          })
            .style("fill", function(e) {
            var nom = lyon_commune.indexOf(e.properties.nom);
            if(nom >= 0){
              return c_lyon_mouseOn;
            } else { 
              return c_n_lyon_mouseOn;
            }
          });
          var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 15) +
                  'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.properties.nom);
        })
        .on('mouseout', function(d) {
        d3.selectAll(".zone").filter(function(e) {
          return e === d;
        }).style("fill", function(d) {
          var nom = lyon_commune.indexOf(d.properties.nom);
          if(nom >= 0){
            return c_lyon;
          } else { 
            return c_n_lyon;
          }
        })
      });
      g.selectAll(".zone").filter(function(d) {
        if(lyon_commune.indexOf(d.properties.nom) >= 0){
          return d;
        };
      }).style("fill", c_lyon)
        .style("stroke", "#ff0000")
        .style("stroke-width", "1");


      g.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("r", 5)
        .attr("class", "dot")
        .attr("cx", function(d) { return projection([d.X, d.Y])[0]; })
        .attr("cy", function(d) { return projection([d.X, d.Y])[1]; })
        .style("fill", "blue")
        .style("stroke", "#000")
        .style("stroke-width", "5")
        .on('mouseover', function(d) {
        d3.selectAll(".dot").filter(function(e) {
          return e === d;
        }).attr("r", 10)
          .style("stroke-width", "10");
        chart(d, tox);
      })
        .on('mouseout', function(d) {
        d3.selectAll(".dot").filter(function(e) {
          return e === d;
        }).attr("r", 5)
          .style("stroke-width", "5")
        g2.selectAll("text").remove();        
        g2.selectAll("rect").remove();
      })
      ;
    }
    
    map(X,Y,scale);
  </script>
</body>
